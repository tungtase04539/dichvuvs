generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Roles: admin, ctv (cộng tác viên), customer (khách hàng)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("customer") // admin, ctv, customer
  phone     String?
  avatar    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Phân cấp CTV
  parentId  String?  // ID của cấp trên
  parent    User?    @relation("AgentHierarchy", fields: [parentId], references: [id])
  subAgents User[]   @relation("AgentHierarchy") // Danh sách cấp dưới

  // Relations
  assignedOrders Order[]       @relation("AssignedStaff")
  messages       Message[]
  referralLinks  ReferralLink[]
  referredOrders Order[]       @relation("ReferrerOrders")
  ctvApplication CTVApplication?
}

// Đơn đăng ký làm CTV
model CTVApplication {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName    String
  phone       String
  email       String
  facebook    String?
  zalo        String?
  experience  String?  // Kinh nghiệm bán hàng
  reason      String?  // Lý do muốn làm CTV
  
  status      String   @default("pending") // pending, approved, rejected
  reviewedBy  String?  // Admin duyệt
  reviewedAt  DateTime?
  rejectReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Service {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String
  longDescription String?  // Chi tiết sản phẩm (HTML/Markdown)
  price           Float
  unit            String   @default("bot")
  image           String?  // URL ảnh đại diện sản phẩm (Supabase Storage)
  videoUrl        String?  // URL video demo (Supabase Storage)
  featured        Boolean  @default(false)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  orders      Order[]
  credentials ProductCredential[]
}

model Order {
  id            String   @id @default(uuid())
  orderCode     String   @unique
  customerName  String
  customerPhone String
  customerEmail String?
  address       String
  district      String?
  city          String   @default("Hồ Chí Minh")
  
  // Service details
  serviceId     String
  service       Service  @relation(fields: [serviceId], references: [id])
  quantity      Float    @default(1)
  unit          String
  
  // Scheduling
  scheduledDate DateTime
  scheduledTime String
  
  // Pricing
  basePrice     Float
  discount      Float    @default(0)
  totalPrice    Float
  
  // Status
  status        String   @default("pending") // pending, confirmed, in_progress, completed, cancelled
  notes         String?
  
  // Assignment
  assignedToId  String?
  assignedTo    User?    @relation("AssignedStaff", fields: [assignedToId], references: [id])
  
  // Chat
  chatSessionId String?
  chatSession   ChatSession? @relation(fields: [chatSessionId], references: [id])
  
  // Credential được gán khi thanh toán thành công
  credential    ProductCredential?
  
  // Referral tracking - đơn hàng từ link ref của ai
  referrerId    String?
  referrer      User?    @relation("ReferrerOrders", fields: [referrerId], references: [id])
  referralCode  String?  // Mã ref được sử dụng
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ChatSession {
  id           String    @id @default(uuid())
  guestId      String    @unique // UUID for anonymous guest
  guestName    String?
  guestPhone   String?
  status       String    @default("active") // active, closed
  lastActivity DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  messages     Message[]
  orders       Order[]
}

model Message {
  id            String      @id @default(uuid())
  chatSessionId String
  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)
  
  senderId      String?     // null for guest messages
  sender        User?       @relation(fields: [senderId], references: [id])
  senderType    String      // guest, staff, admin, system
  senderName    String
  
  content       String
  type          String      @default("text") // text, image, file
  read          Boolean     @default(false)
  
  createdAt     DateTime    @default(now())
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Tài khoản/mật khẩu cho sản phẩm ChatBot
model ProductCredential {
  id          String   @id @default(uuid())
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  accountInfo String   // Thông tin tài khoản (encrypted)
  password    String   // Mật khẩu (encrypted)
  apiKey      String?  // API Key nếu có
  notes       String?  // Ghi chú thêm
  
  isUsed      Boolean  @default(false) // Đã gán cho đơn hàng chưa
  orderId     String?  @unique // Đơn hàng được gán
  order       Order?   @relation(fields: [orderId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Hệ thống link giới thiệu (Referral)
model ReferralLink {
  id          String   @id @default(uuid())
  code        String   @unique // Mã ref duy nhất (VD: REF-ABC123)
  userId      String   // Thuộc về user nào (agent/master_agent)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Thống kê
  clickCount  Int      @default(0) // Số lượt click
  orderCount  Int      @default(0) // Số đơn thành công
  revenue     Float    @default(0) // Tổng doanh thu từ ref
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  clicks      ReferralClick[]
}

// Lưu lại mỗi lượt click vào link ref
model ReferralClick {
  id             String       @id @default(uuid())
  referralLinkId String
  referralLink   ReferralLink @relation(fields: [referralLinkId], references: [id], onDelete: Cascade)
  
  ipAddress      String?
  userAgent      String?
  referer        String?      // Trang nguồn
  
  // Nếu tạo đơn hàng
  converted      Boolean      @default(false)
  orderId        String?
  
  createdAt      DateTime     @default(now())
}
